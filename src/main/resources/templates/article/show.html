<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/header :: head}">
</head>

<body>
<nav class="navbar navbar-fixed-top header" th:replace="~{layout/headernav :: headernav}"></nav>

<div class="navbar navbar-default" id="subnav" th:replace="~{layout/subbnav :: sunav}"></div>

<div class="container" id="main">
  <div class="col-md-12 col-sm-12 col-lg-12">
    <div class="panel panel-default">
      <header class="qna-header">
        <h2 class="qna-title" th:text="${article.title}"></h2>
      </header>
      <div class="content-main">
        <article class="article">
          <div class="article-header">
            <div class="article-header-thumb">
              <img src="https://graph.facebook.com/v2.3/100000059371774/picture"
                   class="article-author-thumb" alt="">
            </div>
            <div class="article-header-text">
              <a th:href="@{/user/{userId}(userId=${article})}" th:text="${article.author}"
                 class="article-author-name">kimmunsu</a>
              <a href="/questions/413"
                 th:text="${#dates.format(article.createdTime, 'yyyy-MM-dd HH:mm')}"
                 class="article-header-time" title="퍼머링크">
                2015-12-30 01:47
                <i class="icon-link"></i>
              </a>
            </div>
          </div>
          <div class="article-doc" th:text="${article.contents}">
          </div>
          <div class="article-util">
            <ul class="article-util-list">
              <li>
                <a class="link-modify-article"
                   th:href="@{/article/{articleId}/update_form(articleId=${article.articleId})}">수정</a>
              </li>
              <li>
                <button onclick="confirmDeleteArticle()" class="link-delete-article">삭제
                </button>
              </li>
              <li>
                <a class="link-modify-article" href="/templates/index.html">목록</a>
              </li>
            </ul>
          </div>
        </article>

        <div class="qna-comment">
          <div class="qna-comment-slipp">
            <div class="qna-comment-slipp-articles">
              <div th:each="reply : ${replies}" class="article">
                <div id="replyTemplate">
                  <div class="article-header">
                    <div class="article-header-thumb">
                      <img src="https://graph.facebook.com/v2.3/1324855987/picture"
                           class="article-author-thumb" alt="">
                    </div>
                    <div class="article-header-text">
                      <a th:href="@{/users/{userId}(userId=${reply.userId})}"
                         th:text="${reply.author}" class="article-author-name"></a>
                      <a th:href="@{'#answer-'}" class="article-header-time" title="퍼머링크"
                         th:text="${#dates.format(reply.createdTime, 'yyyy-MM-dd HH:mm')}"></a>
                    </div>
                  </div>
                  <div class="article-doc comment-doc">
                    <p th:text="${reply.contents}"></p>
                  </div>
                  <div class="article-util">
                    <ul class="article-util-list">
                      <li>
                        <a class="link-modify-article"
                           th:href="@{/article/{articleId}/update_form(articleId=${article.articleId})}">수정</a>
                      </li>
                      <li>
                        <button class="link-delete-comment"
                                type="button" th:data-replyId="${reply.replyId}">삭제
                        </button>
                      </li>
                      <li>
                        <a class="link-modify-article" href="/templates/index.html">목록</a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>


              <form class="submit-write" id="replyForm" method="post" action="/api/reply/create">
                <div class="form-group" style="padding:14px;">
                  <textarea class="form-control" name="contents" id="contents" rows="5"
                            placeholder="댓글을 작성해주세요"></textarea>
                </div>
                <input type="hidden" name="articleId" id="articleId"
                       th:value="${article.articleId}"/>
                <input type="hidden" name="author" id="author" th:value="${session.nickname}"/>
                <input type="hidden" name="userId" id="userId" th:value="${session.userId}"/>
                <button class="btn btn-success pull-right" id="createReply" type="submit">답변하기
                </button>
                <div class="clearfix"/>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- script references -->
<script src="../js/jquery-2.2.0.min.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/scripts.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script th:inline="javascript">
  function confirmDeleteArticle() {
    if (confirm("정말 지울거야?")) {
      var form = document.createElement("form");
      form.method = "POST";
      var articleId = [[${article.articleId}]];
      form.action = "/article/" + articleId + "/delete";
      var hiddenField = document.createElement("input");
      hiddenField.type = "hidden";
      hiddenField.name = "_method";
      hiddenField.value = "DELETE";
      form.appendChild(hiddenField);
      document.body.appendChild(form);
      form.submit();
    }
  }
</script>
<script th:inline="javascript">
  function confirmDeleteReply(reply) {
    if (confirm("정말 지우시겠습니까?")) {
      const form = document.createElement("form");
      form.method = "POST";
      form.action = "/reply/" + reply + "/delete";
      const hiddenField = document.createElement("input");
      hiddenField.type = "hidden";
      hiddenField.name = "_method";
      hiddenField.value = "DELETE";
      form.appendChild(hiddenField);
      document.body.appendChild(form);
      form.submit();
    }
  }
</script>

<script th:inline="javascript">
  $(document).ready(function () {
    $('.submit-write').submit(updateReply);

    function formatDateTime(dateTimeString) {
      const date = new Date(dateTimeString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');

      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function updateReply(e) {

      e.preventDefault();
      let replyBean = {
        author: $("#author").val(),
        contents: $("#contents").val(),
        articleId: $("#articleId").val(),
        userId: $("#userId").val()
      };
      let url = $(this).attr('action');

      let template = `
        <div class="article">
          <div class="article-header">
            <div class="article-header-thumb">
              <img src="https://graph.facebook.com/v2.3/1324855987/picture" class="article-author-thumb" alt="">
            </div>
            <div class="article-header-text">
              <a href="/users/{userId}" class="article-author-name">{author}</a>
              <span class="article-header-time" title="퍼머링크">{createdTime}</span>
            </div>
          </div>
          <div class="article-doc comment-doc">
            <p>{contents}</p>
          </div>
          <div class="article-util">
            <ul class="article-util-list">
              <li>
                <a class="link-modify-article" href="/article/{articleId}/update_form">수정</a>
              </li>
              <li>
                <button class="link-delete-comment" type="button" data-replyId="{replyId}">삭제</button>
              </li>
              <li>
                <a class="link-modify-article" href="/templates/index.html">목록</a>
              </li>
            </ul>
          </div>
        </div>
      `;

      $.ajax({
        type: 'POST',
        url: url,
        data: replyBean,
        dataType: 'json',
        success: function (data) {
          if (!data.contents) {
            alert("본문을 작성해주세요!");
            return;
          }
          if (data.createdTime) {
            data.createdTime = formatDateTime(data.createdTime);
          }
          let formattedTemplate = template.formatJson(data);
          $(".submit-write").before($(formattedTemplate));
          $("textarea[name=contents]").val("");
        },
        error: function (xhr, status, error) {
          console.log("Error: " + error);
        }
      });
    }

    $(document).on("click", ".link-delete-comment", deleteReply);

    function deleteReply(e) {
      let replyId = $(this).attr('data-replyId');
      let target = $(this).closest('.article');
      $.ajax({
        type: 'DELETE',
        url: '/api/reply/' + replyId + '/delete',
        success: function () {
          target.remove();
        },
        error: function (xhr, status, error) {
          console.log("Error: " + error);
        }
      });
    }
  });


</script>
</body>
</html>
