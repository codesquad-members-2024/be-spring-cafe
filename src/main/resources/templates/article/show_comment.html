<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>kakao Java Web Programming</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link th:href="@{/css/reset.css}" rel="stylesheet">
    <!--[if lt IE 9]>
    <script th:src="@{//html5shim.googlecode.com/svn/trunk/html5.js}"></script>
    <![endif]-->
    <link th:href="@{/css/article/show.css}" rel="stylesheet">
</head>
<body>
<div class="background">
    <div th:replace="~{fragments/navigation :: main_nav}"></div>
    <div class="container" id="main">
        <div class="col-md-12 col-sm-12 col-lg-12">
            <div class="panel panel-default" style="width: 80%">
                <header class="post-header">
                    <p class="post-title" th:text="${article.getTitle()}"></p>
                </header>
                <div class="content-main">
                    <article class="article">
                        <div class="article-header">
                            <div class="article-header-text"
                                 style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <p class="article-content" th:text="${article.getUserId()}"
                                       style="display: inline-block;"></p>
                                    <p class="article-content" th:if="${article.isModified()}"
                                       style="display: inline-block;">
                                        <span th:text="${article.getFormattedModifiedTime()}"></span> (수정됨)
                                    </p>
                                    <p class="article-content" th:unless="${article.isModified()}"
                                       th:text="${article.getFormattedCreationTime()}"
                                       style="display: inline-block;"></p>
                                    <p class="article-content" th:text="${article.getViewCount()}"
                                       style="display: inline-block;"></p>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: inline-block;">
                                        <a class="black-component" th:if="${isWriter}"
                                           style="text-align: center; margin-right: 4px"
                                           th:href="@{/article/update/{articleId}(articleId=${articleId})}">수정하기</a>
                                    </div>
                                    <form method="post"
                                          th:action="@{/article/update/{articleId}(articleId=${articleId})}"
                                          style="display: inline-block;">
                                        <button th:if="${isWriter and canDelete}" type="submit" class="black-component"
                                                style="display: flex; justify-content: center; align-items: center; text-align: center;">
                                            삭제하기
                                        </button>
                                        <input type="hidden" name="_method" value="DELETE">
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="article-doc">
                            <p class="article-content" th:text="${article.getContent()}"></p>
                        </div>
                    </article>
                    <div class="post-comment">
                        <div class="post-comment-slipp">
                            <p class="post-comment-count">댓글 <span th:text="${commentList.size()}"></span>개</p>
                            <div class="post-comment-slipp-articles">
                                <article id="comment" class="comment" th:each="comment: ${commentList}">
                                    <div class="article-text" th:inline="text">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <p class="comment-content comment-author-name"
                                               th:text="${comment.getUserId()}"></p>
                                            <div>
                                                <form method="post" class="delete-comment-form"
                                                      th:action="@{/article/{articleId}/comments/{commentId}(articleId=${articleId}, commentId=${comment.getId()})}"
                                                      style="display: inline-block;">
                                                    <button th:if="${writer == comment.getUserId()}"
                                                            onclick="deleteComment(event)"
                                                            class="black-component"
                                                            style="display: flex; justify-content: center; align-items: center; text-align: center;">
                                                        삭제하기
                                                    </button>
                                                    <input type="hidden" name="_method" value="DELETE">
                                                </form>
                                            </div>
                                        </div>
                                        <div class="comment-content comment-doc">
                                            <p th:text="${comment.getContent()}"></p>
                                        </div>
                                        <p class="comment-content comment-time"
                                           th:text="${comment.getFormattedCreationTime()}"></p>
                                    </div>
                                </article>
                                <div class="submit-write">
                                    <div class="comment-writer-container">
                                        <input class="comment-writer" id="userId" name="userId" th:value="${writer}"
                                               readonly/>
                                    </div>
                                    <!-- 오류 메시지를 표시할 span\ 요소 -->
                                    <span class="error-message"
                                          style="margin-top: 10px; margin-left: 25px; color:red; display:none;">댓글은 비어있을 수 없습니다.
                                    </span>
                                    <div class="form-group">
                                        <textarea class="form-control" id="comment_content"
                                                  placeholder="댓글을 남겨보세요."></textarea>
                                    </div>
                                    <button class="post-write-btn" onclick="sendComment()" th:text="등록"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script th:inline="javascript">
    // $(".delete-comment-form button[type='submit']").click(deleteComment(event));

    function sendComment() {
        var comment_content = $("#comment_content").val();
        var param = {"content": comment_content}
        var articleId = [[${articleId}]];

        $.ajax({
            url: "/article/" + [[${articleId}]] + "/comments",
            contentType: "application/json",
            data: JSON.stringify(param),
            type: 'POST',
            success: function (response) {
                if (response.hasOwnProperty("INVALID")) {
                    $(".error-message").show();
                } else if (response.hasOwnProperty("ADD_COMMENT")) {
                    var newComment = response.ADD_COMMENT;
                    var newCommentElement = createCommentElement(articleId, newComment);

                    var commentList = document.querySelector('.post-comment-slipp-articles');
                    var submitWrite = document.querySelector('.submit-write');
                    commentList.insertBefore($(newCommentElement)[0], submitWrite);

                    $("#comment_content").val("");
                    var currentCommentCount = parseInt($(".post-comment-count span").text());
                    var totalCommentCount = currentCommentCount + 1;
                    $(".post-comment-count span").text(totalCommentCount);
                }
            }
        });
    }

    function createCommentElement(articleId, comment) {
        return `
    <article id="comment" class="comment">
      <div class="article-text">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <p class="comment-content comment-author-name">${comment.userId}</p>
          <div>
            <form class="delete-comment-form"
            method="post" action="/article/${articleId}/comments/${comment.id}" style="display: inline-block;">
              <button onclick="deleteComment(event)" class="black-component" style="display: flex; justify-content: center; align-items: center; text-align: center;">
                삭제하기
              </button>
              <input type="hidden" name="_method" value="DELETE">
            </form>
          </div>
        </div>
        <div class="comment-content comment-doc">
          <p>${comment.content}</p>
        </div>
        <p class="comment-content comment-time">${comment.creationTime}</p>
      </div>
    </article>
  `;
    }

    function deleteComment(event) {
        event.preventDefault();

        var form = $(event.target).closest('form');
        var deleteFormUrl = form.attr('action');

        $.ajax({
            url: deleteFormUrl,
            contentType: "application/json",
            type: 'DELETE',
            success: function (response) {
                if (response.hasOwnProperty("INVALID")) {
                    window.location.href = "/article/invalid-modify";
                } else if (response.hasOwnProperty("DELETE_COMMENT")) {
                    $(event.target).closest('article').remove();
                    var currentCommentCount = parseInt($(".post-comment-count span").text());
                    var updatedCommentCount = currentCommentCount - 1;
                    $(".post-comment-count span").text(updatedCommentCount);
                }
            },
            error: function (xhr, status, error) {
                console.error(error);
            }
        });
    }

</script>
</body>
</html>